% AUTHOR: Nicklas Vraa
%
% DESC: A metapackage that defines bundles of packages and commands which all
% revolve around a single element of a document. When defining a new class,
% these bundles may be imported.
%
% ------------------------------------------------------------------------------

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lix}

% SWITCHES: --------------------------------------------------------------------
\newcommand{\useCode}{0}
\newcommand{\useConfigs}{0}
\newcommand{\useCover}{0}
\newcommand{\useFigures}{0}
\newcommand{\useFormats}{0}
\newcommand{\useHeader}{0}
\newcommand{\useHeadings}{0}
\newcommand{\useLists}{0}
\newcommand{\useMath}{0}
\newcommand{\useMeta}{0}
\newcommand{\useRefs}{0}
\newcommand{\useTables}{0}
\newcommand{\useTitlepage}{0}
\newcommand{\useToc}{0}
\newcommand{\useVerso}{0}

\newcommand{\useStdClass}{0} % If using a class not created using LiX.

% SWITCH INTERFACE: ------------------------------------------------------------
\DeclareOption{code}{\renewcommand{\useCode}{1}}
\DeclareOption{configs}{\renewcommand{\useConfigs}{1}}
\DeclareOption{cover}{\renewcommand{\useCover}{1}}
\DeclareOption{figures}{\renewcommand{\useFigures}{1}}
\DeclareOption{formats}{\renewcommand{\useFormats}{1}}
\DeclareOption{header}{\renewcommand{\useHeader}{1}}
\DeclareOption{headings}{\renewcommand{\useHeadings}{1}}
\DeclareOption{lists}{\renewcommand{\useLists}{1}}
\DeclareOption{math}{\renewcommand{\useMath}{1}}
\DeclareOption{meta}{\renewcommand{\useMeta}{1}}
\DeclareOption{refs}{\renewcommand{\useRefs}{1}}
\DeclareOption{tables}{\renewcommand{\useTables}{1}}
\DeclareOption{titlepage}{\renewcommand{\useTitlepage}{1}}
\DeclareOption{toc}{\renewcommand{\useToc}{1}}
\DeclareOption{verso}{\renewcommand{\useVerso}{1}}

\DeclareOption{stdclass}{\renewcommand{\useStdClass}{1}}

\DeclareOption{all}{
    \renewcommand{\useCode}{1}
    \renewcommand{\useConfigs}{1}
    \renewcommand{\useCover}{1}
    \renewcommand{\useFigures}{1}
    \renewcommand{\useFormats}{1}
    \renewcommand{\useHeader}{1}
    \renewcommand{\useHeadings}{1}
    \renewcommand{\useLists}{1}
    \renewcommand{\useMath}{1}
    \renewcommand{\useMeta}{1}
    \renewcommand{\useRefs}{1}
    \renewcommand{\useTables}{1}
    \renewcommand{\useTitlepage}{1}
    \renewcommand{\useToc}{1}
    \renewcommand{\useVerso}{1}
}

\DeclareOption*{\PackageWarning{examplepackage}{Unknown '\CurrentOption'}}
\ProcessOptions\relax

% ESSENTIAL PACKAGES: ----------------------------------------------------------
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage[nottoc]{tocbibind}
\RequirePackage[indent]{parskip}
\RequirePackage{fancyhdr, hyperref, microtype}

% ESSENTIAL SETUP: -------------------------------------------------------------
\hypersetup{hidelinks} % Remove box around links.

% ESSENTIAL COMMANDS: ----------------------------------------------------------
\newcommand{\add}[1]{\input{#1}}
\renewcommand{\url}[2]{\href{#2}{#1}}

% CONFIGS: ---------------------------------------------------------------------
\ifnum\useConfigs=1
    \RequirePackage{fancyhdr, geometry, lastpage, xparse}

    \NewDocumentCommand{\size}{mg}{% Argument 2 is optional.
        \IfValueTF{#2}{%
            \geometry{paper= #1paper, #2}
        }{
            \geometry{paper= #1paper}
        }
    }
    \NewDocumentCommand{\margins}{mggg}{% Arguments 2,3,4 are optional.
        \IfValueTF{#4}{% If four arguments are given.
            \geometry{top=#1, bottom=#2, left=#3, right=#4}%
        }{%
            \IfValueTF{#3}{% If three arguments are given.
                \geometry{top=#1, bottom=#1, left=#2, right=#3}%
            }{%
                \IfValueTF{#2}{% If two arguments are given.
                    \geometry{top=#1, bottom=#1, left=#2, right=#2}%
                }{% If one argument is given.
                    \geometry{top=#1, bottom=#1, left=#1, right=#1}%
                }
            }
        }
        \fancyhfoffset[O]{0pt}
    }
    \NewDocumentCommand{\lang}{m}{%
        \RequirePackage[#1]{babel}
        \newcommand{\theLanguage}{#1}%
    }
\fi

% COVER: -----------------------------------------------------------------------
\ifnum\useCover=1
    \NewDocumentCommand{\cover}{mg}{% Argument 2 is optional.
        \usepackage{eso-pic}%
        \newcommand{\theFront}{#1}%
        \IfValueT{#2}{%
            \newcommand{\theBack}{#2}%
        }
    }
    \NewDocumentCommand{\blurb}{m}{%
        \newcommand{\theBlurb}{#1}%
    }

    \newcommand{\addFrontCover}{
        \@ifundefined{theFront}{}{%
            \AddToShipoutPicture*{%
                \put(0,0){%
                    \parbox[b][\paperheight]{\paperwidth}{%
                        \vfill\centering%
                        \includegraphics[width=\paperwidth,height=\paperheight]{\theFront}%
                        \vfill%
                    }
                }
            }
        }
    }

    \newcommand{\addBackCover}{
        \@ifundefined{theBlurb}{}{%
            \AtEndDocument{%
                \newpage\thispagestyle{empty}%
                \@ifundefined{theBack}{}{%
                    \AddToShipoutPicture*{%
                        \put(0,0){%
                            \parbox[b][\paperheight]{\paperwidth}{%
                                \vfill\centering%
                                \includegraphics[width=\paperwidth,height=\paperheight]{\theBack}%
                                \vfill%
                            }%
                        }%
                    }%
                }

                \centering
                \begin{minipage}{0.8\linewidth}%
                    \centering%
                    \Large{\textbf{\theTitle}}%
                \end{minipage}%

                \par\vspace{5mm}%

                \begin{minipage}{0.9\linewidth}%
                    \Large{\theBlurb}%
                \end{minipage}%

                \@ifundefined{theIsbn}{}{%
                    \par\vspace*{\fill}%
                    \begin{minipage}{0.9\linewidth}%
                        \hfill%
                        \colorbox{white}{%
                            \expandafter\EANBarcode\expandafter{\theIsbn}%
                        }%
                    \end{minipage}%
                }
            }
        }
    }
\fi

% FIGURES: ---------------------------------------------------------------------
\ifnum\useFigures=1
    \RequirePackage{float, graphicx, svg, xparse}

    \def\maxwidth#1{\ifdim\Gin@nat@width>#1 #1\else\Gin@nat@width\fi}

    \NewDocumentCommand{\fig}{mmmg}{ % One command for vectors and images.
        \begin{figure}[h!]
            \centering
            \filename@parse{#3}
            \ifnum\pdfstrcmp{\filename@ext}{svg}=0%
                \sbox0{\includesvg[width=#2\columnwidth]{#3}}%
            \else%
                \sbox0{\includegraphics[width=\maxwidth{#2\columnwidth}]{#3}}%
            \fi%
            \IfValueTF{#4}{%
                \begin{minipage}{\wd0}
                    \usebox0\caption{#4}\label{#1}
                \end{minipage}
            }{%
                \usebox0\label{#1}
            }
        \end{figure}
    }
\fi

% HEADER: ----------------------------------------------------------------------
\ifnum\useHeader=1
    \NewDocumentCommand{\header}{mgg}{%
        \newcommand{\theLeftHeader}{#1}%
        \IfValueT{#2}{%
            \newcommand{\theCenterHeader}{#2}%
        }
        \IfValueT{#3}{%
            \newcommand{\theRightHeader}{#3}%
        }
    }
\fi

% HEADINGS: --------------------------------------------------------------------
\ifnum\useHeadings=1
    \@ifundefined{chapter}{% If class is article-like.
        \NewDocumentCommand{\h}{sm}{%
            \IfBooleanTF{#1}{%
                \section*{#2}\label{#2}%
                \addcontentsline{toc}{section}{#2}%
            }{%
                \section{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsection}{#2}%
            }{%
                \subsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsubsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsubsection}{#2}%
            }{%
                \subsubsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhhh}{sm}{%
            \IfBooleanTF{#1}{%
                \paragraph*{#2}
            }{%
                \paragraph{#2}
            }
        }
    }{% If class is book-like.
        \NewDocumentCommand{\h}{sm}{%
            \IfBooleanTF{#1}{%
                \chapter*{#2}\label{#2}%
                \addcontentsline{toc}{chapter}{#2}%
            }{%
                \chapter{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hh}{sm}{%
            \IfBooleanTF{#1}{%
                \section*{#2}\label{#2}%
                \addcontentsline{toc}{section}{#2}%
            }{%
                \section{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsection}{#2}%
            }{%
                \subsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsubsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsubsection}{#2}%
            }{%
                \subsubsection{#2}\label{#2}%
            }
        }
    }
\fi

% LISTS: -----------------------------------------------------------------------
\ifnum\useLists=1
    \RequirePackage{enumitem}

    \newlist{bullets}{itemize}{10}
    \setlist[bullets,1]{leftmargin=5mm}
    \setlist[bullets]{leftmargin=*,label=$\vcenter{\hbox{\tiny$\bullet$}}$,labelindent=\parindent}

    \newlist{numbers}{enumerate}{10}
    \setlist[numbers,1]{leftmargin=6mm}
    \setlist[numbers]{leftmargin=*,label*=\arabic*.,labelindent=\parindent}
\fi

% MATH: ------------------------------------------------------------------------
\ifnum\useMath=1
    \RequirePackage{amsfonts, amsmath, amssymb, esint, siunitx, xparse}

    \newcommand{\mean}[1]{\overline{#1}}
    \renewcommand{\epsilon}{\varepsilon}

    \renewcommand{\Re}{\mathbb{R}} % Real set.
    \renewcommand{\Im}{\mathbb{I}} % Imaginary set.
    \newcommand{\N}{\mathbb{N}}    % Natural set.
    \newcommand{\Z}{\mathbb{Z}}    % Integer set.
    \newcommand{\Q}{\mathbb{Q}}    % Rational set.
    \newcommand{\C}{\mathbb{C}}    % Complex set.

    \newcommand{\m}[1]{$#1$} % Inline math.

    \RenewDocumentCommand{\math}{mm}{% Block of math.
        \vspace{-0.5\baselineskip}
        \begin{equation}\label{#1}
            #2
        \end{equation}
    }
\fi

% META: ------------------------------------------------------------------------
\ifnum\useMeta=1
    \NewDocumentCommand{\keywords}{m}{%
        \newcommand{\theKeywords}{#1}%
    }
    \newcommand{\addMetadata}{%
        \hypersetup{%
            pdftitle={\@ifundefined{theTitle}{}{\theTitle}},
            pdfauthor={\@ifundefined{theAuthor}{}{\theAuthor}},
            pdfsubject={\@ifundefined{theSubtitle}{}{\theSubtitle}},
            pdfkeywords={\@ifundefined{theKeywords}{}{\theKeywords}},
            pdfcreator={LaTeX with the LiX Package}
        }
    }
\fi

% REFERENCES: ------------------------------------------------------------------
\ifnum\useRefs=1
    \RequirePackage{cite}

    \renewcommand{\r}[1]{\renewcommand\lstlistingautorefname{snippet}\renewcommand\figureautorefname{figure}\renewcommand\equationautorefname{equation}\renewcommand\tableautorefname{table}\renewcommand\sectionautorefname{section}\renewcommand\subsectionautorefname{section}\renewcommand\subsubsectionautorefname{section}\renewcommand\paragraphautorefname{section}\renewcommand\subparagraphautorefname{section}\autoref{#1}}

    \newcommand{\R}[1]{\renewcommand\lstlistingautorefname{Snippet}\renewcommand\figureautorefname{Figure}\renewcommand\equationautorefname{Equation}\renewcommand\tableautorefname{Table}\renewcommand\sectionautorefname{Section}\renewcommand\subsectionautorefname{Section}\renewcommand\subsubsectionautorefname{Section}\renewcommand\paragraphautorefname{Section}\renewcommand\subparagraphautorefname{Section}\autoref{#1}}


    \NewDocumentCommand{\bib}{mg}{%
        \IfValueTF{#2}{%
            \bibliographystyle{#2}
        }{%
            \bibliographystyle{unsrt} % Sort by order of appearance.
        }

        \bibliography{#1}
    }
\fi

% TABLES: ----------------------------------------------------------------------
\ifnum\useTables=1
    \RequirePackage{caption, tabularray, xparse}

    \NewDocumentCommand{\tabs}{mmmg}{
        \begin{table}[h!]
            \centering
            \ifnum\pdfstrcmp{#2}{cols}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,2,Z} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #3
                    \end{tblr}%
                }
            \else\ifnum\pdfstrcmp{#2}{rows}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,Z} = {0.1pt,solid},
                        vline{2} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #3
                    \end{tblr}%
                }
            \else\ifnum\pdfstrcmp{#2}{grid}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,2,Z} = {0.1pt,solid},
                        vline{2} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #3
                    \end{tblr}%
                }
            \else
                \sbox0{%
                    \begin{tblr}{#2}%
                        #3
                    \end{tblr}%
                }
            \fi\fi\fi
            \IfValueTF{#4}{%
                \begin{minipage}{\wd0}%
                    \usebox0\caption{#4}\label{#1}%
                \end{minipage}%
            }{%
                \usebox0\label{#1}%
            }
        \end{table}
    }
\fi

% TITLEPAGE: -------------------------------------------------------------------
\ifnum\useTitlepage=1
    \NewCommandCopy{\oldtitle}{\title}%
    \RenewDocumentCommand{\title}{m}{%
        \newcommand{\theTitle}{#1}%
    }
    \NewDocumentCommand{\subtitle}{m}{%
    \newcommand{\theSubtitle}{#1}%
    }
    \NewCommandCopy{\oldauthor}{\author}%
    \RenewDocumentCommand{\author}{m}{%
        \newcommand{\theAuthor}{#1}%
    }
    \NewCommandCopy{\olddate}{\date}%
    \RenewDocumentCommand{\date}{m}{%
        \newcommand{\theDate}{#1}%
    }
\fi

% TOC: -------------------------------------------------------------------------
\ifnum\useToc=1
    \newcommand{\toc}{\tableofcontents}
    \@ifundefined{chapter}{}{% If class is article-like.
        \addtocontents{toc}{\protect\thispagestyle{empty}}
    }
\fi

% VERSO: -----------------------------------------------------------------------
\ifnum\useVerso=1
    \RequirePackage{xparse}

    \NewDocumentCommand{\license}{mmm}{%
        \usepackage[type={#1},modifier={#2},version={#3}]{doclicense}%
    }
    \NewDocumentCommand{\isbn}{m}{%
        \usepackage{GS1}%
        \GSSetup{ocrb=true,module_height=5ex}%
        \newcommand{\theIsbn}{#1}%
    }
    \NewDocumentCommand{\note}{m}{%
        \newcommand{\theNote}{#1}%
    }
    \NewDocumentCommand{\publisher}{m}{%
        \newcommand{\thePublisher}{#1}%
    }
    \NewDocumentCommand{\edition}{mm}{
        \RequirePackage{numspell}
        \newcommand{\theEdition}{#1}%
        \newcommand{\theYear}{#2}%
    }
    \NewDocumentCommand{\dedicate}{mm}{%
        \newcommand{\theDedicatee}{#1}%
        \newcommand{\theMessage}{#2}%
    }
    \NewDocumentCommand{\thank}{m}{%
        \newcommand{\theThankyou}{#1}%
    }

    \newcommand{\addVersoPage}{
        \thispagestyle{empty}{%
            \clearpage\raggedright\footnotesize%
            \begin{minipage}{0.6\linewidth}
                \@ifundefined{theDedicatee}{}{%
                    {\large{\textit{To \theDedicatee}}\par%
                    \vspace{3mm}%
                    \normalsize{\textit{\theMessage.}}}%
                }
            \end{minipage}

            \null\vfill%

            \begin{minipage}{0.6\linewidth}
                \@ifundefined{theNote}{}{%
                    \textbf{Author's Note}: \theNote%
                    \vspace{8mm}\par%
                }
                \@ifundefined{thePublisher}{}{%
                    \textbf{Publisher}: \thePublisher\par%
                }
                \@ifundefined{theEdition}{}{%
                    \Ordnumspell{\theEdition} edition, published in \theYear.\par%
                }
                \@ifundefined{theThankyou}{}{%
                    \theThankyou.\par%
                }
                \@ifpackageloaded{doclicense}{%
                    \vspace{8mm}%
                    \textbf{Copyright} 2022--\the\year\ \theAuthor\par%
                    \doclicenseLongText \par%
                    \vspace{1mm}%
                    \doclicenseIcon%
                    \par%
                }{}
            \end{minipage}

            \@ifundefined{theIsbn}{}{%
                \vspace{8mm}%
                ISBN: \theIsbn \hspace{2mm} \par\vspace{1mm}%
                \expandafter\EANBarcode\expandafter{\theIsbn}%
            }
        }%
        \newpage%
    }
\fi

% CODE: ------------------------------------------------------------------------
\ifnum\useCode=1
    \RequirePackage{caption, inconsolata, listings, xcolor, xparse}

    \lstdefinestyle{inline}{% Inline styling.
        basicstyle=\ttfamily\small, breaklines=true%
    }

    \RenewDocumentCommand{\c}{v}{%
        \lstinline[style=inline]{#1}%
    }

    \lstdefinestyle{block}{% Block styling.
        basicstyle=\ttfamily\footnotesize,
        commentstyle=\color[rgb]{0.5,0.5,0.5},
        breaklines=true,
        numbers=left,
        gobble=4,
        numberstyle=\tiny,
        numbersep=7pt,
        aboveskip=0.5em,
        belowskip=0em,
        showstringspaces=false,
        xleftmargin=14pt,
        postbreak=\mbox{\hspace{-2.5em}\textcolor{gray}{$\hookrightarrow$}\space\space}
    }

    \ExplSyntaxOn
        \NewDocumentCommand{\code}{mm +v g}{%
            \begingroup%
                \noindent{\tiny\dotfill}%
                \newlinechar=\endlinechar
                \exp_args:Nx \scantokens{
                    \string\begin{lstlisting}[\unexpanded{language=#2,style=block}]
                    #3
                    \string\end{lstlisting}%
                }
                \noindent{\tiny\dotfill\ \MakeUppercase#2\ }
                \IfValueTF{#4}{%
                    \captionsetup{type=lstlisting}%
                    \caption{#4}%
                }{}
                \label{#1}%
            \endgroup%
        }
    \ExplSyntaxOff

    % Add reference category for code blocks.
    \renewcommand{\lstlistingname}{Snippet}
    \providecommand*{\lstlistingautorefname}{snippet}
\fi

% FORMATS: ---------------------------------------------------------------------
\ifnum\useFormats=1
    \RequirePackage{ulem}

    \normalem % Allow italized and underlined text.
    \renewcommand{\b}[1]{\textbf{#1}} % Bold.
    \renewcommand{\i}[1]{\textit{#1}} % Italic.
    \renewcommand{\u}[1]{\uline{#1}}  % Underline.
    \newcommand{\s}[1]{\sout{#1}}     % Strikethrough.
\fi


% LAYOUT -----------------------------------------------------------------------
\ifnum\useStdClass=1
    \AddToHook{begindocument/end}{%
        \@ifundefined{theTitle}{}{%

            \@ifundefined{theSubtitle}{%
                \oldtitle{\theTitle}%
            }{%
                \oldtitle{\theTitle\\[0.4ex]%
                \large\theSubtitle}%
            }
        }
        \@ifundefined{theAuthor}{%
            \oldauthor{}%
        }{%
            \oldauthor{\theAuthor}%
        }
        \@ifundefined{theDate}{%
            \olddate{}%
        }{%
            \olddate{\theDate}%
        }

        \@ifundefined{theTitle}{}{%
            \maketitle%
        }
        \addMetadata
    }
\fi
